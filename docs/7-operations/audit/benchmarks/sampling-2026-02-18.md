# Sampling Benchmark Report

> **Date**: 2026-02-18
> **Platform**: Linux 6.6.87.2 (WSL2), x86_64
> **Profile**: `bench` (optimized)
> **Framework**: criterion 0.5
> **Source**: `rustml/nlp/benches/sampling.rs`

## Results

| Benchmark | Mean | Lower (95% CI) | Upper (95% CI) | Outliers |
|-----------|------|-----------------|-----------------|----------|
| `argmax_32k` | 32.1 µs | 31.7 µs | 32.5 µs | 10% |
| `argmax_128k` | 127.0 µs | 124.6 µs | 129.7 µs | 8% |
| `top_k` k=10, 32k vocab | 159.5 µs | 154.2 µs | 164.8 µs | 1% |
| `top_k` k=50, 32k vocab | 157.0 µs | 151.4 µs | 163.1 µs | 0% |
| `top_k` k=100, 32k vocab | 151.1 µs | 147.0 µs | 156.2 µs | 3% |
| `top_p` p=0.9, 32k vocab | 1.625 ms | 1.584 ms | 1.668 ms | 2% |
| `top_p` p=0.95, 32k vocab | 1.794 ms | 1.739 ms | 1.845 ms | 2% |
| `top_p` p=0.99, 32k vocab | 1.830 ms | 1.786 ms | 1.878 ms | 3% |
| `rep_penalty` 100 tokens, 32k vocab | 34.7 µs | 33.2 µs | 36.3 µs | 0% |
| `sample_categorical` 32k vocab | 367.6 µs | 347.4 µs | 387.9 µs | 3% |

## Analysis

### Scaling

- **argmax** scales linearly with vocabulary size: 32 µs (32k) vs 127 µs (128k) — ~4x for 4x vocab.
- **top_k** is roughly constant across k values (151–159 µs), dominated by the partial sort overhead rather than k itself.
- **top_p** is ~10x slower than top_k (1.6–1.8 ms vs ~155 µs) because it requires a full sort of the logit array before cumulative probability scanning.

### Hot-path budget

For a 32k-vocab model generating at ~10 tokens/sec (100 ms/token budget):

| Sampler | Time | % of budget |
|---------|------|-------------|
| argmax (greedy) | 32 µs | 0.03% |
| top_k + rep_penalty | ~190 µs | 0.19% |
| top_p + rep_penalty | ~1.86 ms | 1.86% |
| sample_categorical | 368 µs | 0.37% |

Sampling overhead is negligible relative to the forward pass. No optimization needed at current scale.

### Recommendations

- **Prefer `top_k`** over `top_p` for latency-sensitive workloads (10x faster).
- **top_p optimization opportunity**: The full sort could be replaced with a partial sort + linear scan, reducing complexity from O(n log n) to O(n).
- **Regression threshold**: Flag any benchmark that regresses >20% from these baseline numbers.

## Reproduction

```bash
cargo bench -p rustml-nlp
```

HTML reports with histograms are generated in `target/criterion/`.
